{% extends 'appreciation/base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheers for {{ event.name }}</title>
    <link rel="stylesheet" href="{% static 'poststyle.css' %}">
    <!-- Add a Google Font for styling -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <ul class="navbar-links">
            <li><a href="{% url 'post_list' event.id %}">All Cheers</a></li>
            <li><a href="{% url 'view_my_posts' event.id %}">View My Cheers</a></li>
            <li><a href="{% url 'event_participants' event.id %}">View Participants</a></li>
        </ul>
    </nav>

    <!-- Header Section -->
    <header class="header">
        <h1>Spread the Cheer for {{ event.name }}</h1>
        <p>Let‚Äôs celebrate every moment by showing gratitude!</p>
        <img src="{% static 'images/gratitude.png' %}" alt="Gratitude Banner" class="header-image" style="width: 100%; max-height: 350px; object-fit: cover;">
    </header>

    <!-- Create Post Button -->
    {% if is_active %}
    <div class="create-post">
        <a href="{% url 'create_post' event.id %}" class="btn-primary">Cheer Someone!</a>
    </div>
    {% endif %}

    <!-- Gratitude Section -->
    <section class="gratitude-section">
        <h2>Share the Love!</h2>
        <!-- <div class="gratitude-gallery">
            <img src="{% static 'images/gratitude_heart.png' %}" alt="Heart Icon">
            <img src="{% static 'images/gratitude_smile.png' %}" alt="Smile Icon">
            <img src="{% static 'images/gratitude_handshake.png' %}" alt="Handshake Icon">
        </div> -->
    </section>

    <!-- Post Grid -->
    <div class="post-grid">
        {% for res in posts %}
        {% with post=res.post reaction=res.reaction %}
        <div class="post-tile" data-post-id="{{ post.id }}">
            <p class="post-author">
                {% if post.is_anonymous %}
                Anonymous
                {% else %}
                {{ post.author.username }}
                {% endif %}
            </p>
            <h4 class="post-content">{{ post.content }}</h4>


{% block title %} Cheers for {{ event.name }} {% endblock %}
{% block style %} <link rel="stylesheet" href="{% static 'poststyle.css' %}"> {% endblock %}
{% block content %}
<div class="container">
    <h1>Cheers for {{ event.name }}</h1>

    <div class="tab-navigation">
        <!-- Toggle between all posts and view my posts -->
        <a href="{% url 'post_list' event.id %}">All Cheers</a> |
        <a href="{% url 'view_my_posts' event.id %}">View My Cheers</a>
    </div>

    {% if my_posts_view %}
        <h2>Cheers dedicated to you</h2>
    {% else %}
        <h2>All Cheers</h2>
    {% endif %}

    <!-- Create Post Button (only show when the event is active) -->
    {% if is_active %}
    <div class="create-post">
        <a href="{% url 'create_post' event.id %}">Cheer someone! </a>
    </div>
    {% endif %}

    <div class="post-grid">
        {% for res in posts %}
        {% with post=res.post reaction=res.reaction %}
        <div class="post-tile" data-post-id="{{ post.id }}">
            <p>
                {% if post.is_anonymous %}
                Anonymous
                {% else %}
                {{ post.author.username }}
                {% endif %}
            </p>
            <h4>{{ post.content }}</h4>

            <!-- Reaction Section -->
            <div class="reactions-container">
                <div class="selected-reaction">
                    <div class="reaction-values">
                        {% for react_type, react_count in reaction.items %}
                        {% if react_count > 0 %}
                        {{ react_count }} {{ react_type }}&nbsp;
                        {{ react_count }} {{ react_type }},
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Emoji Reaction Button -->
                <div class="emoji-button">
                    <button class="reaction-btn">React</button>
                    <div class="emoji-dropdown">
                        <button class="emoji-btn" title="Like">üëç</button>
                        <button class="emoji-btn" title="Love">‚ù§Ô∏è</button>
                        <button class="emoji-btn" title="Laugh">üòÇ</button>
                        <button class="emoji-btn" title="Wow">üòÆ</button>
                        <button class="emoji-btn" title="Sad">üò¢</button>
                        <button class="emoji-btn" title="Angry">üò°</button>
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}
    </div>
</div>

    <script>
        document.querySelectorAll('.emoji-dropdown button').forEach(button => {
            button.addEventListener('click', function() {
                const emoji = this.getAttribute('title');
                const postId = this.closest('.post-tile').getAttribute('data-post-id');
                fetch(`/appreciation/add_reaction/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({ 'emoji': emoji })
                })
                .then(response => response.json())
                .then(data => {
                    let value = "";
                    Object.entries(data).forEach(([key, count]) => {
                        value += `${key}: ${count}, `;
                    });
                    this.closest('.post-tile').querySelector('.reaction-values').innerHTML = value.slice(0, -2);
                });
                document.querySelector('.reaction-values').innerHTML = value.slice(0, -2);  // Update the reaction values
            });
        });
    });
</script>
{% endblock %}
