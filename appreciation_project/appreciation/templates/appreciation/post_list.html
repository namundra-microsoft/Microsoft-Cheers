{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Cheers for {{ event.name }}</title>
    <link rel="stylesheet" href="{% static 'poststyle.css' %}">
</head>
<body>
    <div class="container">
        <h1>Cheers for {{ event.name }}</h1>

        <div class="tab-navigation">
            <!-- Toggle between all posts and view my posts -->
            <a href="{% url 'post_list' event.id %}">All Cheers</a> |
            <a href="{% url 'view_my_posts' event.id %}">View My Cheers</a>
        </div>

        {% if my_posts_view %}
            <h2>Cheers dedicated to you</h2>
        {% else %}
            <h2>All Cheers</h2>
        {% endif %}

        <!-- Create Post Button (only show when the event is active) -->
        {% if is_active %}
        <div class="create-post">
            <a href="{% url 'create_post' event.id %}">Cheer someone! </a>
        </div>
        {% endif %}

        <div class="post-grid">
            {% for res in posts %}
            {% with post=res.post reaction=res.reaction %}
            <div class="post-tile" data-post-id="{{ post.id }}">
                <p>
                    {% if post.is_anonymous %}
                    Anonymous
                    {% else %}
                    {{ post.author.username }}
                    {% endif %}
                </p>
                <h4>{{ post.content }}</h4>

                <!-- Reaction Section -->
                <div class="reactions-container">
                    <div class="selected-reaction">
                        <div class="reaction-values">
                            {% for react_type, react_count in reaction.items %}
                            {% if react_count > 0 %}
                            {{ react_count }} {{ react_type }},
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Emoji Reaction Button -->
                    <div class="emoji-button">
                        <button class="reaction-btn">React</button>
                        <div class="emoji-dropdown">
                            <button class="emoji-button" title="Like">üëç</button>
                            <button class="emoji-button" title="Love">‚ù§Ô∏è</button>
                            <button class="emoji-button" title="Laugh">üòÇ</button>
                            <button class="emoji-button" title="Wow">üòÆ</button>
                            <button class="emoji-button" title="Sad">üò¢</button>
                            <button class="emoji-button" title="Angry">üò°</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
    </div>

    <script>
        document.querySelectorAll('.emoji-dropdown button').forEach(button => {
            button.addEventListener('click', function() {
                const emoji = this.getAttribute('title');
                const postId = this.closest('.post-tile').getAttribute('data-post-id');
                fetch(`/appreciation/add_reaction/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'emoji': emoji
                    })
                })
                .then(response => response.json())  // Parse the JSON response
                .then(data => {
                    let value = "";
                    Object.entries(data).forEach(([key, count]) => {
                        value += `${key}: ${count}, `;
                    });
                    document.querySelector('.reaction-values').innerHTML = value.slice(0, -2);  // Update the reaction values
                });
            });
        });
    </script>
</body>
</html>
